1. プロダクト名

tfspec
(読み: ティーエフスペック / 意味: Terraform Specification)

2. パーパス (Purpose)

Terraformで管理される複数環境間の意図された構成差分を、仕様書 (Specification) として宣言的に管理し、仕様書から逸脱するあらゆる構成ドリフトを自動的に検出することで、コード化されたインフラの設計と一貫性を強制する。

3. 解決する課題

ディレクトリ分離モデルでTerraformを運用する際、環境間の構成差分（インスタンスサイズの違いなど）の管理は避けられません。しかし、その差分の理由やあるべき状態がコードから読み取れない場合、将来の変更時に意図が失われ、誤った修正や設定の先祖返りを引き起こします。手作業での差分管理は、これらの意図の喪失、変更の適用漏れ、設定ミスを招き、障害やセキュリティリスクの直接的な原因となります。

当プロダクトは、この課題を解決するためのTerraform構成仕様検証ツールです。

4. コアコンセプト

「すべての意図された差分は、.tfspec/ ディレクトリ内の仕様書ファイルに宣言されなければならない」

環境間のすべての差分は、ツール固有の .tfspec/ ディレクトリ内に配置された仕様書ファイル (spec.hcl または specs/ ディレクトリ) に、Terraformの構文を再利用して宣言的に記述されます。ツールは、実際の環境のコードが、この仕様書に書かれた宣言と完全に一致しているかを検証します。

5. 主な機能

.tfspecディレクトリによる設定の一元管理:
tfspecに関連するすべての設定は、プロジェクトルートの.tfspec/ディレクトリに集約されます。これにより、プロジェクトのルートディレクトリをクリーンに保ち、既存のプロジェクトにも非侵襲的に導入できます。

柔軟な仕様書ファイルの管理:
プロジェクトの規模に応じて、2つの管理方法をシームレスに選択できます。

単一ファイル管理: シンプルなプロジェクトでは、.tfspec/spec.hcl にすべての仕様を記述します。

分割ファイル管理: 大規模なプロジェクトでは、.tfspec/specs/ ディレクトリを作成し、その中に関心事ごと（例: databases.hcl, networking.hcl）にファイルを分割して仕様を管理できます。

構造化コメントによる仕様の宣言:
仕様書ファイル内では、差分のある行の末尾に # tfspec(...) という関数形式の構造化コメントを記述することで、差分の仕様を明確に宣言します。

env: 差分が適用される環境名を指定します。（例: env="prd"、env=["stg", "dev"]）

reason: なぜその差分が存在するのか、人間が理解できる理由を記述します。（例: reason="本番DBのパフォーマンス要件を満たすため"）

直感的な差分表現:

属性値の差分: 値が異なる属性の行末にコメントを記述します。

code
Hcl
download
content_copy
expand_less
resource "aws_instance" "web" {
  instance_type = "t3.large" # tfspec(env="prd", reason="高負荷対応")
  instance_type = "t3.small" # tfspec(env="stg", reason="コスト最適化")
}

存在の差分: 特定の環境にのみ存在するリソースは、中身を空にしたブロックで宣言します。

code
Hcl
download
content_copy
expand_less
# このアラームは本番環境にのみ存在する
resource "aws_cloudwatch_metric_alarm" "high_cpu" {} # tfspec(env="prd", reason="SLA保証のための必須監視")

差分の自動検証:
tfspec check <env1> <env2> コマンドは、.tfspec/ ディレクトリを自動的に探索して仕様書ファイルを読み込みます。検出された実際の差分が仕様書に理由と共に正しく宣言されているかを検証し、仕様書と一致しない差分が見つかった場合のみ、CI/CDパイプラインを失敗させるエラーとして報告します。

GitHub Issue ダッシュボード連携 (オプション):
検証結果をMarkdown形式で出力し、CI/CD経由で単一のGitHub Issueを継続的に更新することで、チームはいつでも環境間の一貫性の最新状況を一覧できる「生きたダッシュボード」を手に入れることができます。

6. ワークフロー

仕様の定義: 開発者は、.tfspec/spec.hcl または .tfspec/specs/ ディレクトリ内のファイルに、# tfspec(...)形式で差分の仕様を宣言します。

コードの記述: 各環境のTerraformコードは、仕様書の定義と一致するように記述・メンテナンスされます。

継続的な検証: CI/CDパイプラインは、コードが変更されるたびにtfspec checkを実行。仕様書で説明できない差分がないかを常に監視します。

状況の可視化: GitHub Issueダッシュボードで、チーム全員がインフラの健全性と構成差分の仕様を共有します。

7. 差別化要因

クリーンで自己完結した構成: すべての設定が.tfspec/ディレクトリに集約されるため、既存のプロジェクトにクリーンかつ非侵襲的に導入できます。

表現力豊かで直感的な構文: 独自ブロックのような学習コストの高いDSLを避け、Terraformユーザーが日常的に使う構文と、読みやすい構造化コメントだけで、差分の「何を(What)」と「なぜ(Why)」を管理できます。

生きた仕様書 (Living Specification): 仕様書ファイルが、単なる差分リストではなく、インフラ構成の設計意図を記録した「生きた仕様書」として機能します。これにより、インフラの保守性と持続可能性が大幅に向上します。

非破壊的なガードレール: ユーザーのコードを一切変更・生成せず、宣言された仕様と実装の一致を検証する安全なガードレールとして機能します。
